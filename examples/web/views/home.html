<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #2563eb;
            margin-bottom: 0.5rem;
        }
        .subtitle {
            color: #666;
            margin-bottom: 2rem;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-top: 0;
            color: #1f2937;
            font-size: 1.25rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        select, button, input[type="text"], input[type="number"] {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            font-size: 1rem;
        }
        input[type="text"], input[type="number"] {
            width: 220px;
            background: white;
        }
        select {
            width: 220px;
            background: white;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #6b7280;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .btn-preview {
            background: #10b981;
        }
        .btn-preview:hover {
            background: #059669;
        }
        .export-form {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem 1rem;
        }
        .checkbox-grid label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 400;
        }
        .radio-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .hint {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #6b7280;
        }
        .status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            display: none;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            display: block;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            display: block;
        }
        .status.loading {
            background: #dbeafe;
            color: #1e40af;
            display: block;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        .history-table th,
        .history-table td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .history-table th {
            background: #f9fafb;
            font-weight: 600;
        }
        .history-table tr:hover {
            background: #f9fafb;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-completed { background: #d1fae5; color: #065f46; }
        .badge-running { background: #dbeafe; color: #1e40af; }
        .badge-queued { background: #fef3c7; color: #92400e; }
        .badge-failed { background: #fee2e2; color: #991b1b; }
        .badge-canceled { background: #f3f4f6; color: #6b7280; }
        .actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            margin-right: 0.25rem;
        }
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        .api-docs {
            font-family: monospace;
            background: #1f2937;
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }
        .api-docs code {
            color: #60a5fa;
        }
        /* Inbox Widget */
        .inbox-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .inbox-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .inbox-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .inbox-badge {
            background: #2563eb;
            color: white;
            border-radius: 999px;
            padding: 0.2rem 0.6rem;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
            line-height: 1.2;
        }
        .inbox-badge:empty,
        .inbox-badge[data-count="0"] {
            background: #9ca3af;
        }
        .inbox-status {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            color: #6b7280;
            padding: 0.25rem 0.6rem;
            background: #f3f4f6;
            border-radius: 999px;
        }
        .inbox-status::before {
            content: "";
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: #9ca3af;
            flex-shrink: 0;
        }
        .inbox-status.connected {
            background: #ecfdf5;
            color: #065f46;
        }
        .inbox-status.connected::before {
            background: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        .inbox-status.disconnected {
            background: #fffbeb;
            color: #92400e;
        }
        .inbox-status.disconnected::before {
            background: #f59e0b;
        }
        .inbox-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .inbox-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 1rem;
            transition: all 0.15s ease;
        }
        .inbox-item:hover {
            border-color: #d1d5db;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .inbox-item.unread {
            background: #eff6ff;
            border-color: #bfdbfe;
            border-left: 3px solid #2563eb;
        }
        .inbox-item-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .inbox-title {
            font-weight: 600;
            color: #111827;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .inbox-item.unread .inbox-title::before {
            content: "";
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #2563eb;
            border-radius: 50%;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .inbox-status-badge {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            flex-shrink: 0;
        }
        .inbox-status-badge.unread {
            background: #dbeafe;
            color: #1e40af;
        }
        .inbox-status-badge.read {
            background: #f3f4f6;
            color: #6b7280;
        }
        .inbox-body {
            color: #4b5563;
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }
        .inbox-body:empty {
            display: none;
        }
        .inbox-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .inbox-meta {
            color: #9ca3af;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .inbox-meta svg {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }
        .inbox-actions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        .inbox-actions button,
        .inbox-actions a {
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .inbox-actions .btn-link {
            background: transparent;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }
        .inbox-actions .btn-link:hover {
            background: #f3f4f6;
            color: #374151;
        }
        .inbox-actions .btn-action {
            background: #2563eb;
            color: white;
        }
        .inbox-actions .btn-action:hover {
            background: #1d4ed8;
        }
        .inbox-actions .btn-dismiss {
            background: transparent;
            color: #9ca3af;
            border: none;
            padding: 0.3rem;
        }
        .inbox-actions .btn-dismiss:hover {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <h1>{{ title }}</h1>
    <p class="subtitle">Export data from your application in multiple formats</p>

    <div class="card">
        <h2>Datagrid Export</h2>
        <div class="export-form">
            <div class="form-group">
                <label for="definition">Dataset</label>
                <select id="definition" onchange="updateColumns()">
                    <option value="users">Users</option>
                    <option value="products">Products</option>
                    <option value="orders">Orders</option>
                </select>
            </div>
            <div class="form-group">
                <label for="format">Format</label>
                <select id="format">
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                    <option value="ndjson">NDJSON</option>
                    <option value="xlsx">Excel (XLSX)</option>
                    <option value="template">HTML (Template)</option>
                    <option value="pdf">PDF</option>
                </select>
            </div>
            <div class="form-group">
                <label for="search">Search</label>
                <input id="search" type="text" placeholder="Search users...">
            </div>
            <div class="form-group">
                <label for="roleFilter">Role Filter</label>
                <select id="roleFilter">
                    <option value="">Any</option>
                    <option value="admin">Admin</option>
                    <option value="editor">Editor</option>
                    <option value="user">User</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sort">Sort</label>
                <select id="sort">
                    <option value="">Default</option>
                    <option value="created_at:desc">Newest first</option>
                    <option value="created_at:asc">Oldest first</option>
                    <option value="name:asc">Name A-Z</option>
                    <option value="name:desc">Name Z-A</option>
                </select>
            </div>
            <div class="form-group" style="min-width: 280px;">
                <label>Columns</label>
                <div id="columns" class="checkbox-grid"></div>
            </div>
            <div class="form-group" style="min-width: 260px;">
                <label>Selection</label>
                <div class="radio-group">
                    <label><input type="radio" name="selectionMode" value="all" checked onchange="toggleSelectionMode()"> All rows</label>
                    <label><input type="radio" name="selectionMode" value="ids" onchange="toggleSelectionMode()"> Selected IDs</label>
                </div>
                <input id="selectedIds" type="text" placeholder="usr_001, usr_002" disabled oninput="updateEstimatedRows()">
            </div>
            <div class="form-group">
                <label for="estimatedRows">Estimated Rows</label>
                <input id="estimatedRows" type="number" min="0" value="10" oninput="updateEstimatedRows()">
            </div>
            <div class="form-group">
                <label for="delivery">Delivery</label>
                <select id="delivery">
                    <option value="auto" selected>Auto</option>
                    <option value="sync">Sync</option>
                    <option value="async">Async</option>
                </select>
            </div>
            <div class="form-group">
                <button id="exportBtn" onclick="triggerExport()">Export</button>
            </div>
        </div>
        <p class="hint">Auto switches to async above {{ max_rows|integer }} estimated rows.</p>
        <div id="exportStatus" class="status"></div>
    </div>

    <div class="card">
        <div class="inbox-header">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>
                Notifications
                <span id="inboxBadge" class="inbox-badge">0</span>
            </h2>
            <div class="inbox-controls">
                <span id="inboxStatus" class="inbox-status disconnected">Offline</span>
                <button class="btn-secondary" onclick="loadInbox()">Refresh</button>
            </div>
        </div>
        <div id="inboxContainer" class="inbox-list">
            <div class="empty-state">No notifications yet</div>
        </div>
    </div>

    <div class="card">
        <h2>Scheduled Delivery</h2>
        <div class="export-form">
            <div class="form-group">
                <label for="scheduleDefinition">Definition</label>
                <select id="scheduleDefinition">
                    {% for def in definitions %}
                    <option value="{{ def }}">{{ def|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="scheduleFormat">Format</label>
                <select id="scheduleFormat">
                    {% for format in formats %}
                    <option value="{{ format }}">{{ format|upper }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="scheduleMode">Schedule Mode</label>
                <select id="scheduleMode">
                    <option value="" selected>Default (env/config)</option>
                    <option value="execute_sync">Execute Sync</option>
                    <option value="enqueue">Enqueue</option>
                </select>
            </div>
            <div class="form-group">
                <label for="deliveryMode">Delivery Mode</label>
                <select id="deliveryMode">
                    <option value="link" selected>Link</option>
                    <option value="attachment">Attachment</option>
                </select>
            </div>
            <div class="form-group">
                <label for="scheduleRecipients">Recipients</label>
                <input id="scheduleRecipients" type="text" value="{{ schedule_recipients }}" placeholder="demo@example.com">
            </div>
            <div class="form-group">
                <button id="scheduleBtn" onclick="triggerScheduledDelivery()">Run Scheduled Delivery</button>
            </div>
        </div>
        <p class="hint">Default uses EXPORT_DELIVERY_SCHEDULE_MODE; execute sync runs immediately.</p>
        <div id="scheduleStatus" class="status"></div>
    </div>

    <div class="card">
        <h2>Export History</h2>
        <button class="btn-secondary" onclick="loadHistory()" style="margin-bottom: 1rem;">Refresh</button>
        <div id="historyContainer">
            <div class="empty-state">Click Refresh to load export history</div>
        </div>
    </div>

    <div class="card">
        <h2>API Reference</h2>
        <div class="api-docs">
            <p><code>POST /admin/exports</code> - Request a new export</p>
            <p><code>GET /admin/exports?definition=users</code> - Request export via querystring</p>
            <pre>{
  "definition": "users",
  "format": "csv",
  "query": {
    "filters": [{ "field": "role", "op": "eq", "value": "admin" }],
    "search": "alice",
    "sort": [{ "field": "created_at", "desc": true }]
  },
  "columns": ["id", "email", "name"],
  "selection": { "mode": "all" },
  "estimated_rows": 10,
  "delivery": "auto"
}</pre>
            <p><code>GET /admin/exports/history</code> - List export history</p>
            <p><code>GET /admin/exports/:id</code> - Get export status</p>
            <p><code>GET /admin/exports/:id/download</code> - Download artifact</p>
            <p><code>DELETE /admin/exports/:id</code> - Delete/cancel export</p>
            <p><code>GET /api/inbox</code> - List inbox notifications</p>
            <p><code>GET /api/inbox/badge</code> - Unread inbox count</p>
            <p><code>PATCH /api/inbox/read</code> - Mark inbox items read/unread</p>
            <p><code>DELETE /api/inbox/:id</code> - Dismiss inbox item</p>
            <p><code>GET /ws/inbox</code> - WebSocket inbox stream</p>
            <p><code>GET /api/definitions</code> - List available definitions</p>
            <p><code>POST /api/schedule/deliveries</code> - Run scheduled delivery (execute_sync|enqueue)</p>
        </div>
    </div>

    <script>
        const definitionColumns = {
            users: ["id", "email", "name", "role", "created_at"],
            products: ["id", "name", "sku", "price", "quantity"],
            orders: ["id", "customer", "total", "status", "created_at"]
        };

        function updateColumns() {
            const definition = document.getElementById('definition').value;
            const container = document.getElementById('columns');
            const cols = definitionColumns[definition] || [];
            container.innerHTML = cols.map(col => `
                <label><input type="checkbox" value="${col}" checked> ${col}</label>
            `).join('');
        }

        function toggleSelectionMode() {
            const mode = document.querySelector('input[name="selectionMode"]:checked').value;
            const idsInput = document.getElementById('selectedIds');
            idsInput.disabled = mode !== 'ids';
            if (mode !== 'ids') {
                idsInput.value = '';
            }
            updateEstimatedRows();
        }

        function parseSelectedIds() {
            const idsRaw = document.getElementById('selectedIds').value || '';
            return idsRaw.split(',').map(id => id.trim()).filter(Boolean);
        }

        function parseRecipients(raw) {
            return (raw || '').split(',').map(value => value.trim()).filter(Boolean);
        }

        function updateEstimatedRows() {
            const mode = document.querySelector('input[name="selectionMode"]:checked').value;
            const estimatedInput = document.getElementById('estimatedRows');
            if (mode === 'ids') {
                const ids = parseSelectedIds();
                estimatedInput.value = ids.length;
                estimatedInput.disabled = true;
            } else {
                estimatedInput.disabled = false;
            }
        }

        function buildQuery(definition) {
            const search = document.getElementById('search').value.trim();
            const role = document.getElementById('roleFilter').value;
            const sortValue = document.getElementById('sort').value;

            const query = { filters: [], sort: [] };
            if (search) {
                query.search = search;
            }
            if (role && definition === 'users') {
                query.filters.push({ field: 'role', op: 'eq', value: role });
            }
            if (sortValue) {
                const [field, dir] = sortValue.split(':');
                query.sort.push({ field: field, desc: dir === 'desc' });
            }

            if (!query.search && query.filters.length === 0 && query.sort.length === 0) {
                return null;
            }
            return query;
        }

        function buildExportRequest() {
            const definition = document.getElementById('definition').value;
            const format = document.getElementById('format').value;
            const delivery = document.getElementById('delivery').value;
            const mode = document.querySelector('input[name="selectionMode"]:checked').value;
            const estimatedRowsValue = parseInt(document.getElementById('estimatedRows').value, 10) || 0;

            const columns = Array.from(document.querySelectorAll('#columns input[type="checkbox"]'))
                .filter(input => input.checked)
                .map(input => input.value);

            const payload = {
                definition: definition,
                format: format,
                columns: columns,
                selection: {
                    mode: mode,
                    ids: mode === 'ids' ? parseSelectedIds() : []
                },
                estimated_rows: estimatedRowsValue,
                delivery: delivery
            };

            const query = buildQuery(definition);
            if (query) {
                payload.query = query;
            }
            return payload;
        }

        function triggerExport() {
            const statusEl = document.getElementById('exportStatus');
            const btn = document.getElementById('exportBtn');

            statusEl.className = 'status loading';
            statusEl.textContent = 'Starting export...';
            btn.disabled = true;

            fetch('/admin/exports', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(buildExportRequest())
            })
            .then(response => {
                if (response.status === 202) {
                    return response.json().then(data => ({ async: true, data }));
                }
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Export failed'); });
                }
                const exportId = response.headers.get('X-Export-Id');
                return response.blob().then(blob => ({ async: false, blob, exportId }));
            })
            .then(result => {
                if (result.async) {
                    handleAsyncExport(result.data);
                    return;
                }
                const { blob, exportId } = result;
                const definition = document.getElementById('definition').value;
                const format = document.getElementById('format').value;

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${definition}-export.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                statusEl.className = 'status success';
                statusEl.textContent = `Export completed! ID: ${exportId || 'N/A'}`;
                btn.disabled = false;

                loadHistory();
            })
            .catch(error => {
                statusEl.className = 'status error';
                statusEl.textContent = `Export failed: ${error.message}`;
                btn.disabled = false;
            });
        }

        function buildScheduledDeliveryRequest() {
            const definition = document.getElementById('scheduleDefinition').value;
            const format = document.getElementById('scheduleFormat').value;
            const scheduleMode = document.getElementById('scheduleMode').value;
            const deliveryMode = document.getElementById('deliveryMode').value;
            const recipientsRaw = document.getElementById('scheduleRecipients').value;

            return {
                definition: definition,
                format: format,
                schedule_mode: scheduleMode,
                delivery_mode: deliveryMode,
                recipients: parseRecipients(recipientsRaw)
            };
        }

        function triggerScheduledDelivery() {
            const statusEl = document.getElementById('scheduleStatus');
            const btn = document.getElementById('scheduleBtn');

            statusEl.className = 'status loading';
            statusEl.textContent = 'Scheduling delivery...';
            btn.disabled = true;

            fetch('/api/schedule/deliveries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(buildScheduledDeliveryRequest())
            })
            .then(response => response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.error || 'Schedule failed');
                }
                return data;
            }))
            .then(data => {
                statusEl.className = 'status success';
                statusEl.textContent = `Delivery ${data.mode} for ${data.definition} (${data.format}) in ${data.duration_ms}ms.`;
                btn.disabled = false;
            })
            .catch(error => {
                statusEl.className = 'status error';
                statusEl.textContent = `Schedule failed: ${error.message}`;
                btn.disabled = false;
            });
        }

        function handleAsyncExport(data) {
            const statusEl = document.getElementById('exportStatus');
            const btn = document.getElementById('exportBtn');
            const exportId = data.id;
            if (!exportId) {
                statusEl.className = 'status error';
                statusEl.textContent = 'Export failed: missing export ID';
                btn.disabled = false;
                return;
            }
            statusEl.className = 'status loading';
            statusEl.textContent = `Export queued. ID: ${exportId}`;
            loadHistory();
            pollExport(exportId, 0);
        }

        function pollExport(exportId, attempt) {
            const statusEl = document.getElementById('exportStatus');
            const btn = document.getElementById('exportBtn');
            const maxAttempts = 30;

            if (attempt >= maxAttempts) {
                statusEl.className = 'status error';
                statusEl.textContent = 'Export polling timed out.';
                btn.disabled = false;
                return;
            }

            fetch(`/admin/exports/${exportId}`)
                .then(response => response.json())
                .then(record => {
                    if (record.state === 'completed') {
                        statusEl.className = 'status success';
                        statusEl.textContent = `Export ready! Downloading ${exportId}...`;
                        btn.disabled = false;
                        downloadExport(exportId);
                        loadHistory();
                        return;
                    }
                    if (record.state === 'failed' || record.state === 'canceled') {
                        statusEl.className = 'status error';
                        statusEl.textContent = `Export ${record.state}.`;
                        btn.disabled = false;
                        return;
                    }
                    statusEl.className = 'status loading';
                    statusEl.textContent = `Export ${record.state}...`;
                    setTimeout(() => pollExport(exportId, attempt + 1), 1000);
                })
                .catch(error => {
                    statusEl.className = 'status error';
                    statusEl.textContent = `Polling failed: ${error.message}`;
                    btn.disabled = false;
                });
        }

        function loadHistory() {
            const container = document.getElementById('historyContainer');
            container.innerHTML = '<div class="empty-state">Loading...</div>';

            fetch('/admin/exports/history')
                .then(response => response.json())
                .then(data => {
                    const exportsList = Array.isArray(data) ? data : (data.exports || []);
                    if (exportsList.length === 0) {
                        container.innerHTML = '<div class="empty-state">No exports yet</div>';
                        return;
                    }

                    const html = `
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Definition</th>
                                    <th>Format</th>
                                    <th>Status</th>
                                    <th>Rows</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${exportsList.map(exp => `
                                    <tr>
                                        <td><code>${exp.id.slice(0, 8)}...</code></td>
                                        <td>${exp.definition}</td>
                                        <td>${exp.format}</td>
                                        <td><span class="badge badge-${exp.state}">${exp.state}</span></td>
                                        <td>${exp.counts?.processed || 0}</td>
                                        <td>${new Date(exp.created_at).toLocaleString()}</td>
                                        <td class="actions">
                                            ${exp.state === 'completed' ? `<button onclick="downloadExport('${exp.id}')">Download</button>` : ''}
                                            ${exp.state === 'completed' && exp.format === 'template' ? `<button class="btn-preview" onclick="previewExport('${exp.id}')">Preview</button>` : ''}
                                            <button class="btn-secondary" onclick="deleteExport('${exp.id}')">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    container.innerHTML = html;
                })
                .catch(error => {
                    container.innerHTML = `<div class="empty-state">Error loading history: ${error.message}</div>`;
                });
        }

        function downloadExport(id) {
            window.location.href = `/admin/exports/${id}/download`;
        }

        function previewExport(id) {
            window.open(`/admin/exports/${id}/preview`, '_blank');
        }

        function deleteExport(id) {
            if (!confirm('Are you sure you want to delete this export?')) {
                return;
            }

            fetch(`/admin/exports/${id}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(() => {
                    loadHistory();
                })
                .catch(error => {
                    alert(`Delete failed: ${error.message}`);
                });
        }

        let inboxSocket = null;
        let inboxReconnectTimer = null;
        let inboxRefreshTimer = null;

        function setInboxStatus(connected) {
            const statusEl = document.getElementById('inboxStatus');
            if (!statusEl) {
                return;
            }
            if (connected) {
                statusEl.textContent = 'Live';
                statusEl.classList.add('connected');
                statusEl.classList.remove('disconnected');
            } else {
                statusEl.textContent = 'Offline';
                statusEl.classList.add('disconnected');
                statusEl.classList.remove('connected');
            }
        }

        function updateInboxBadge(count) {
            const badgeEl = document.getElementById('inboxBadge');
            if (!badgeEl) {
                return;
            }
            const value = Number.isFinite(count) ? count : 0;
            badgeEl.textContent = value;
        }

        function loadInboxBadge() {
            fetch('/api/inbox/badge')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Inbox disabled');
                    }
                    return response.json();
                })
                .then(data => {
                    updateInboxBadge(data.unread || 0);
                })
                .catch(() => {
                    updateInboxBadge(0);
                });
        }

        function loadInbox() {
            const container = document.getElementById('inboxContainer');
            if (!container) {
                return;
            }
            container.innerHTML = '<div class="empty-state">Loading...</div>';

            fetch('/api/inbox')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Inbox disabled');
                    }
                    return response.json();
                })
                .then(data => {
                    const items = Array.isArray(data) ? data : (data.items || data.inbox || []);
                    if (!items.length) {
                        container.innerHTML = '<div class="empty-state">No notifications yet</div>';
                        return;
                    }
                    const html = items.map(item => {
                        const title = escapeHTML(item.title || 'Notification');
                        const body = formatInboxBody(item.body || '');
                        const createdAt = item.created_at ? formatRelativeTime(item.created_at) : '';
                        const actionURL = item.action_url ? escapeHTML(item.action_url) : '';
                        const actionLabel = item.metadata && item.metadata.cta_label ? escapeHTML(item.metadata.cta_label) : 'View';
                        return `
                            <div class="inbox-item ${item.unread ? 'unread' : ''}">
                                <div class="inbox-item-header">
                                    <div class="inbox-title">${title}</div>
                                    <span class="inbox-status-badge ${item.unread ? 'unread' : 'read'}">${item.unread ? 'New' : 'Read'}</span>
                                </div>
                                <div class="inbox-body">${body}</div>
                                <div class="inbox-footer">
                                    <div class="inbox-meta">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                        <span>${createdAt}</span>
                                    </div>
                                    <div class="inbox-actions">
                                        <button class="btn-link" onclick="toggleInboxRead('${item.id}', ${item.unread})">
                                            ${item.unread ? 'Mark read' : 'Mark unread'}
                                        </button>
                                        ${actionURL ? `<a class="btn-action" href="${actionURL}" target="_blank" rel="noopener noreferrer">${actionLabel}</a>` : ''}
                                        <button class="btn-dismiss" onclick="dismissInbox('${item.id}')" title="Dismiss">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    container.innerHTML = html;
                })
                .catch(error => {
                    container.innerHTML = `<div class="empty-state">${error.message}</div>`;
                });
        }

        function formatRelativeTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            if (diffSec < 60) return 'Just now';
            if (diffMin < 60) return `${diffMin}m ago`;
            if (diffHour < 24) return `${diffHour}h ago`;
            if (diffDay < 7) return `${diffDay}d ago`;
            return date.toLocaleDateString();
        }

        function toggleInboxRead(id, unread) {
            fetch('/api/inbox/read', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ids: [id],
                    read: !!unread,
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Update failed'); });
                }
                refreshInboxSoon();
            })
            .catch(error => {
                alert(`Update failed: ${error.message}`);
            });
        }

        function dismissInbox(id) {
            fetch(`/api/inbox/${id}`, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Dismiss failed'); });
                    }
                    refreshInboxSoon();
                })
                .catch(error => {
                    alert(`Dismiss failed: ${error.message}`);
                });
        }

        function refreshInboxSoon() {
            if (inboxRefreshTimer) {
                clearTimeout(inboxRefreshTimer);
            }
            inboxRefreshTimer = setTimeout(() => {
                loadInbox();
                loadInboxBadge();
            }, 250);
        }

        function connectInboxSocket() {
            if (inboxSocket) {
                inboxSocket.close();
            }
            const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
            inboxSocket = new WebSocket(`${scheme}://${window.location.host}/ws/inbox`);

            inboxSocket.onopen = function() {
                setInboxStatus(true);
            };

            inboxSocket.onclose = function() {
                setInboxStatus(false);
                if (inboxReconnectTimer) {
                    return;
                }
                inboxReconnectTimer = setTimeout(() => {
                    inboxReconnectTimer = null;
                    connectInboxSocket();
                }, 2000);
            };

            inboxSocket.onerror = function() {
                inboxSocket.close();
            };

            inboxSocket.onmessage = function(event) {
                let msg = null;
                try {
                    msg = JSON.parse(event.data);
                } catch (err) {
                    return;
                }
                if (!msg || !msg.topic) {
                    return;
                }
                if (msg.badge !== undefined && msg.badge !== null) {
                    updateInboxBadge(msg.badge);
                }
                if (msg.topic === 'inbox.badge') {
                    return;
                }
                if (msg.topic.startsWith('inbox.')) {
                    refreshInboxSoon();
                }
            };
        }

        function escapeHTML(value) {
            return (value || '')
                .toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatInboxBody(text) {
            return escapeHTML(text).replace(/\n/g, '<br>');
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateColumns();
            loadHistory();
            loadInbox();
            loadInboxBadge();
            connectInboxSocket();
        });
    </script>
</body>
</html>
